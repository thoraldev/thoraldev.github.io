<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/img/divfr.png" />
    <title>Fraccionador</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <style>
        :root {
            /* Paleta de Colores Moderna */
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #00d2ff;
            --bg-gradient: linear-gradient(135deg, #4e54c8, #8f94fb);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow-lg: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
            --success: #38a169;
            --error: #e53e3e;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-dark);
            padding: 20px;
        }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 1000px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        /* Scrollbar estética */
        .container::-webkit-scrollbar { width: 8px; }
        .container::-webkit-scrollbar-track { background: transparent; }
        .container::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        h2 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Grid Layout para Inputs */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            outline: none;
            background: #f8fafc;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.15);
            background: white;
        }

        /* Botones */
        .actions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        button:active { transform: scale(0.98); }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 14px rgba(78, 84, 200, 0.4);
        }
        
        .btn-danger {
            background: #fff;
            color: var(--error);
            border: 2px solid var(--error);
        }

        .btn-danger:hover { background: #fff5f5; }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none;}

        /* Panel de Información */
        .info-panel {
            background: linear-gradient(to right, #ffffff, #f7fafc);
            border-left: 5px solid var(--accent-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item p { margin: 0; font-size: 0.85rem; color: var(--text-light); }
        .info-item span { font-size: 1.2rem; font-weight: 700; color: var(--text-dark); }

        /* Toggle Switch Avanzado */
        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
            user-select: none;
        }

        /* Tabla Estilizada */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #edf2f7;
            text-align: center;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        tr:nth-child(even) { background-color: #f8fafc; }
        tr:hover { background-color: #ebf4ff; }

        /* Mensajes y Detalles DOF */
        .dof-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            opacity: 0;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 0 20px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .dof-details.show {
            max-height: 500px;
            opacity: 1;
            padding: 20px;
            margin-top: 10px;
        }

        .status-msg { font-weight: 600; text-align: center; margin-top: 10px; min-height: 24px; margin-bottom: 15px;}
        .text-error { color: var(--error); }
        .text-success { color: var(--success); }

        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .footer a { color: var(--primary-color); text-decoration: none; font-weight: bold; }

    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="https://thoraal.github.io/">
                <img src="assets/img/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'"/>
            </a>
            <h2><i class="fa-solid fa-money-bill-transfer"></i> Fraccionador</h2>
            <p style="color: var(--text-light);">Herramienta de fraccionamiento inteligente</p>
        </header>

        <div class="controls-grid">
            <div class="input-group">
                <label for="numero">Monto a Fraccionar</label>
                <input type="number" id="numero" placeholder="Max $35,000.00" min="0" max="35000">
            </div>
            
            <div class="input-group">
                <label for="moneda">Divisa</label>
                <select id="moneda">
                    <option value="usd">USD - Dólar Americano</option>
                    <option value="eur">EUR - Euro</option>
                    <option value="cad">CAD - Canadiense</option>
                    <option value="otro">Otra divisa...</option>
                </select>
                <input type="text" id="monedaOtro" placeholder="Nombre divisa" style="display: none; margin-top: 5px;">
            </div>

            <div class="input-group">
                <label for="tipoCambio">Tipo de Cambio</label>
                <input type="number" id="tipoCambio" placeholder="Introduce TC" step="0.01">
            </div>
        </div>

        <div class="info-panel">
            <div class="info-item">
                <p>Monto Original</p>
                <span id="labelMonto">$0.00</span>
            </div>
            <div class="info-item">
                <p>T.C. Aplicado</p>
                <span id="labelTipoCambio">0.00</span>
            </div>
            <div class="info-item">
                <p>Total MXN</p>
                <span id="labelTotal">$0.00</span>
            </div>
        </div>
        
        <div class="status-msg" id="mensajeEstado"></div>

        <div class="actions-container">
            <button class="btn-primary" id="imprimirBtn" onclick="imprimirPDF()" disabled>
                <i class="fa-solid fa-file-pdf"></i> Imprimir PDF
            </button>
            <button class="btn-danger" onclick="borrarTodo()">
                <i class="fa-solid fa-trash"></i> Borrar
            </button>
        </div>

        <div class="advanced-toggle" onclick="toggleDofDetails()">
            <i class="fa-solid fa-sliders"></i> <span>Ver datos DOF y Límites</span>
        </div>

        <div class="dof-details" id="dofDetails">
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 10px;">
                <div class="input-group">
                    <label>Fecha DOF</label>
                    <input type="date" id="fechaTipoCambio">
                </div>
                <div class="info-item">
                    <p>TC DOF Oficial:</p>
                    <span id="tipoDeCambioOficial">--</span>
                </div>
            </div>
            <div style="display: flex; gap: 30px; border-top: 1px solid #ccc; padding-top: 10px;">
                <div class="info-item"><p>Límite Min:</p><span id="minimoValor">--</span></div>
                <div class="info-item"><p>Límite Max:</p><span id="maximoValor">--</span></div>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="resultado">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ingreso (Divisa)</th>
                        <th>Check</th>
                        <th>MXN</th>
                        <th>Restante</th>
                        <th>Acumulado MXN</th>
                        <th>Acumulado Div</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="footer">
            Developed with <i class="fa-solid fa-heart" style="color: #e53e3e;"></i> by Alejandro Toral
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // UTILIDADES
        // ---------------------------------------------------------
        
        // Generador PRNG xoshiro128ss
        function xoshiro128ss(a) {
            let s = new Uint32Array(4);
            s[0] = a >>> 0; s[1] = (a * 0x9e3779bb) >>> 0;
            s[2] = (a * 0x85ebca6b) >>> 0; s[3] = (a * 0xc2b2ae35) >>> 0;
            return function () {
                const result = (s[0] + s[3]) >>> 0;
                const t = s[1] << 9;
                s[2] ^= s[0]; s[3] ^= s[1];
                s[1] ^= s[2]; s[0] ^= s[3];
                s[2] ^= t; s[3] = (s[3] << 11) | (s[3] >>> 21);
                return result / 0x100000000;
            };
        }

        // Formato moneda
        const formatMoney = (num) => {
            return (num || 0).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // Debounce para API
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ---------------------------------------------------------
        // LÓGICA PRINCIPAL
        // ---------------------------------------------------------
        document.addEventListener("DOMContentLoaded", () => {
            // Fecha hoy
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            document.getElementById("fechaTipoCambio").value = today.toISOString().split("T")[0];
            
            // Iniciar listeners
            setupEventListeners();
            
            // Llamada inicial API
            fetchDataForDate();
            
            // Autocalcular si hay datos guardados
            setTimeout(() => handleInputChanges(), 500);
        });

        function setupEventListeners() {
            const inputs = ['numero', 'tipoCambio', 'moneda', 'monedaOtro'];
            
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('input', () => {
                        handleInputChanges();
                    });
                }
            });

            // Eventos API
            document.getElementById('fechaTipoCambio').addEventListener('change', fetchDataForDate);
            document.getElementById('moneda').addEventListener('change', fetchDataForDate);
            document.getElementById('tipoCambio').addEventListener('input', debounce(fetchDataForDate, 800));
        }

        function handleInputChanges() {
            mostrarCamposMoneda();
            actualizarLimites();
            validarMaximo();
            calcularFraccionamiento();
        }

        function mostrarCamposMoneda() {
            const isOtro = document.getElementById("moneda").value === "otro";
            const inputOtro = document.getElementById("monedaOtro");
            inputOtro.style.display = isOtro ? "block" : "none";
            if(isOtro && inputOtro.value) {
                inputOtro.value = inputOtro.value.charAt(0).toUpperCase() + inputOtro.value.slice(1).toLowerCase();
            }
        }

        function validarMaximo() {
            const el = document.getElementById("numero");
            if (el.value && parseInt(el.value) > 35000) {
                mostrarMensaje("El monto máximo es 35,000", "error");
                el.value = 35000;
            }
        }

        function actualizarLimites() {
            const monto = parseInt(document.getElementById("numero").value) || 0;
            let min = 600;

            if (monto < 5000) min = 50;
            else if (monto < 10000) min = 300;
            else if (monto < 15000) min = 400;
            else if (monto < 20000) min = 500;
            else if (monto < 25000) min = 550;

            document.getElementById('minimoValor').textContent = min;
        }

        function calcularFraccionamiento() {
            const numeroVal = document.getElementById("numero").value;
            const tcVal = document.getElementById("tipoCambio").value;
            const btnPdf = document.getElementById("imprimirBtn");

            // Si faltan datos, limpiar
            if (!numeroVal || !tcVal) {
                limpiarTabla();
                return;
            }

            const total = parseInt(numeroVal);
            const tc = parseFloat(tcVal);

            // Actualizar Labels Header
            document.getElementById("labelMonto").textContent = `$${formatMoney(total)}`;
            document.getElementById("labelTipoCambio").textContent = tc.toFixed(2);
            document.getElementById("labelTotal").textContent = `$${formatMoney(total * tc)}`;

            // Lógica de Fraccionamiento
            const seed = total;
            const rng = xoshiro128ss(seed);
            
            let partes = new Set();
            let restante = total;
            const min = parseInt(document.getElementById('minimoValor').textContent) || 400;
            const max = parseInt(document.getElementById('maximoValor').textContent) || 990;
            
            // Loop seguro
            let safetyCounter = 0;
            const maxLoops = 2000; 

            while (restante > 0 && partes.size < 45 && safetyCounter < maxLoops) {
                safetyCounter++;
                
                // Intento final exacto
                if (restante <= max && restante >= min && !partes.has(restante)) {
                    partes.add(restante);
                    restante = 0;
                    break;
                }

                let fraccion = Math.floor(rng() * (max - min + 1)) + min;
                fraccion = Math.round(fraccion / 5) * 5; 
                
                if (fraccion > restante) fraccion = restante;

                if (!partes.has(fraccion) && fraccion <= restante && fraccion > 0) {
                    partes.add(fraccion);
                    restante -= fraccion;
                }
            }

            // Remanente forzoso
            if (restante > 0) {
                partes.add(restante);
            }

            const sumaReal = Array.from(partes).reduce((a, b) => a + b, 0);
            
            if (sumaReal !== total) {
                mostrarMensaje(`Error matemático: Suma ${sumaReal} vs ${total}. Ajusta monto levemente.`, "error");
                btnPdf.disabled = true;
                return;
            }

            mostrarMensaje("Cálculo exitoso y validado.", "success");
            btnPdf.disabled = false;
            renderTabla(Array.from(partes), total, tc);
        }

        function renderTabla(partes, total, tc) {
            const tbody = document.querySelector("#resultado tbody");
            tbody.innerHTML = "";
            
            let restante = total;
            let acumuladoMxn = 0;
            let acumuladoDiv = 0;

            partes.forEach((parte, index) => {
                restante -= parte;
                if(restante < 0) restante = 0;
                
                const mxnRow = parte * tc;
                acumuladoMxn += mxnRow;
                acumuladoDiv += parte;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-weight:bold; color:var(--primary-color);">${formatMoney(parte)}</td>
                    <td style="color:#cbd5e0;">[ &nbsp;&nbsp; ]</td>
                    <td>$${formatMoney(mxnRow)}</td>
                    <td>$${formatMoney(restante)}</td>
                    <td>$${formatMoney(acumuladoMxn)}</td>
                    <td>$${formatMoney(acumuladoDiv)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleDofDetails() {
            const el = document.getElementById("dofDetails");
            el.classList.toggle("show");
        }

        function mostrarMensaje(texto, tipo) {
            const el = document.getElementById("mensajeEstado");
            el.textContent = texto;
            el.className = "status-msg " + (tipo === "error" ? "text-error" : "text-success");
        }

        function limpiarTabla() {
            document.querySelector("#resultado tbody").innerHTML = "";
            document.getElementById("labelMonto").textContent = "$0.00";
            document.getElementById("labelTotal").textContent = "$0.00";
            document.getElementById("imprimirBtn").disabled = true;
            mostrarMensaje("", "normal");
        }

        function borrarTodo() {
            document.getElementById("numero").value = "";
            document.getElementById("tipoCambio").value = "";
            document.getElementById("monedaOtro").value = "";
            document.getElementById("moneda").value = "usd";
            document.getElementById("monedaOtro").style.display = "none";
            limpiarTabla();
        }

        // ---------------------------------------------------------
        // API BANXICO
        // ---------------------------------------------------------
        async function fetchDataForDate() {
            const fechaVal = document.getElementById('fechaTipoCambio').value;
            const tokens = [
                '812a7355fa14f189ea64e3112c255d3993069dee78d526892de342526057c6ad',
                'ea9e2067b75621dad3e50a21cd6f7f094060da2f1d0c6d6d4a65520c2e29459b'
            ];

            let dataFound = false;

            for (const token of tokens) {
                try {
                    const url = `https://www.banxico.org.mx/SieAPIRest/service/v1/series/SF60653/datos/${fechaVal}/${fechaVal}/?token=${token}`;
                    const resp = await fetch(url);
                    if (!resp.ok) continue;

                    const json = await resp.json();
                    if (json.bmx?.series?.[0]?.datos?.length > 0) {
                        const dato = json.bmx.series[0].datos[0].dato;
                        document.getElementById('tipoDeCambioOficial').textContent = `$${dato}`;
                        
                        // Recalcular límites con TC oficial si hay input usuario
                        const tcUsuario = parseFloat(document.getElementById("tipoCambio").value);
                        if (tcUsuario > 0) {
                            const limiteCalculado = (parseFloat(dato) * 1000 / tcUsuario).toFixed(0);
                            const esUsd = document.getElementById('moneda').value === 'usd';
                            
                            let maxFinal = limiteCalculado;
                            if (esUsd && limiteCalculado > 1000) maxFinal = 990;
                            
                            document.getElementById('maximoValor').textContent = maxFinal;
                        }
                        dataFound = true;
                        break;
                    }
                } catch (e) { console.error(e); }
            }

            if (!dataFound) {
                document.getElementById('tipoDeCambioOficial').textContent = "N/A";
            }
        }

        // ---------------------------------------------------------
        // IMPRESIÓN PDF
        // ---------------------------------------------------------
        function imprimirPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'letter' });
            
            const monto = document.getElementById("numero").value;
            const tc = document.getElementById("tipoCambio").value;
            const monedaSel = document.getElementById("moneda");
            const nombreMoneda = monedaSel.value === "otro" ? document.getElementById("monedaOtro").value : monedaSel.options[monedaSel.selectedIndex].text;

            // Header con fondo azul
            doc.setFillColor(78, 84, 200); 
            doc.rect(0, 0, 612, 60, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("Reporte de Desglose de Efectivo", 40, 40);

            // Detalles
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 40, 90);
            doc.text(`Divisa: ${nombreMoneda}`, 40, 105);
            doc.text(`Monto: $${formatMoney(monto)} | TC: ${tc}`, 250, 90);
            
            // Cabecera Tabla
            let y = 140;
            const cols = [40, 80, 180, 260, 360, 460];
            
            doc.setFillColor(240, 240, 240);
            doc.rect(30, y - 15, 550, 20, 'F');
            doc.setFont(undefined, 'bold');
            doc.text("#", cols[0], y);
            doc.text("Cantidad", cols[1], y);
            doc.text("MXN", cols[2], y);
            doc.text("Restante", cols[3], y);
            doc.text("Acum MXN", cols[4], y);
            doc.text("Acum Div", cols[5], y);
            
            y += 25;
            doc.setFont(undefined, 'normal');

            // Filas
            const filas = document.querySelectorAll("#resultado tbody tr");
            filas.forEach(fila => {
                const celdas = fila.querySelectorAll("td");
                doc.text(celdas[0].innerText, cols[0], y);
                doc.text(celdas[1].innerText, cols[1], y);
                doc.text(celdas[3].innerText, cols[2], y); // Col 3 es MXN
                doc.text(celdas[4].innerText, cols[3], y);
                doc.text(celdas[5].innerText, cols[4], y);
                doc.text(celdas[6].innerText, cols[5], y);
                
                y += 15;
                if(y > 750) { doc.addPage(); y = 40; }
            });

            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
        }
    </script>
</body>

</html>
